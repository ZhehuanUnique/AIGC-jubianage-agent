# 修复 502 Bad Gateway 错误 - 详细步骤

## 问题诊断

502 错误表示 Nginx 无法连接到后端服务器（localhost:3002），通常是因为：
1. 后端服务未运行
2. 后端服务崩溃
3. 后端服务启动失败
4. 端口被占用但服务无响应

## 快速修复步骤

### 方法1：使用脚本（推荐）

**Windows PowerShell:**
```powershell
.\快速修复502错误.ps1
```

**Linux/Mac/Git Bash:**
```bash
bash 快速修复502错误.sh
```

### 方法2：手动修复

#### 步骤1：SSH 连接到服务器
```bash
ssh ubuntu@119.45.121.152
```

#### 步骤2：检查 PM2 服务状态
```bash
pm2 list
```

**预期结果：**
- 如果看到 `aigc-agent` 状态为 `online`，说明服务在运行
- 如果状态为 `errored` 或 `stopped`，需要重启

#### 步骤3：检查端口占用
```bash
lsof -i :3002
# 或者
netstat -tulpn | grep 3002
```

**预期结果：**
- 如果端口被占用，应该看到 Node.js 进程
- 如果端口未被占用，说明服务未运行

#### 步骤4：测试后端服务
```bash
curl http://localhost:3002/api/health
```

**预期结果：**
- 如果返回 JSON 响应，说明服务正常
- 如果连接失败，说明服务未运行

#### 步骤5：查看错误日志
```bash
cd /var/www/aigc-agent/server
pm2 logs aigc-agent --err --lines 50
```

**常见错误：**
- **数据库连接失败**：检查 `.env` 文件中的数据库配置
- **端口被占用**：杀死占用端口的进程
- **依赖缺失**：运行 `npm install`
- **内存不足**：检查服务器内存使用情况

#### 步骤6：重启服务

**如果服务在运行但无响应：**
```bash
cd /var/www/aigc-agent/server
pm2 restart aigc-agent
```

**如果服务未运行：**
```bash
cd /var/www/aigc-agent/server
pm2 stop aigc-agent 2>/dev/null
pm2 delete aigc-agent 2>/dev/null
pm2 start index.js --name aigc-agent --autorestart --max-memory-restart 1G
pm2 save
```

#### 步骤7：验证修复
```bash
# 等待几秒让服务启动
sleep 5

# 再次测试
curl http://localhost:3002/api/health

# 检查 PM2 状态
pm2 list
```

## 常见问题排查

### 问题1：服务启动后立即崩溃

**检查日志：**
```bash
pm2 logs aigc-agent --err --lines 100
```

**可能原因：**
- 数据库连接失败
- 环境变量缺失
- 代码语法错误
- 依赖包缺失

**解决方法：**
```bash
cd /var/www/aigc-agent/server
npm install
# 检查 .env 文件
cat .env | grep -E "DB_|PORT|NODE_ENV"
```

### 问题2：端口被占用但服务无响应

**查找并杀死进程：**
```bash
# 查找占用端口的进程
lsof -i :3002

# 杀死进程（替换 PID 为实际进程ID）
kill -9 <PID>

# 重启服务
cd /var/www/aigc-agent/server
pm2 restart aigc-agent
```

### 问题3：服务启动失败（依赖问题）

**重新安装依赖：**
```bash
cd /var/www/aigc-agent/server
rm -rf node_modules package-lock.json
npm install
pm2 restart aigc-agent
```

### 问题4：数据库连接失败

**检查数据库配置：**
```bash
cd /var/www/aigc-agent/server
cat .env | grep DB_
```

**确保数据库服务运行：**
```bash
# 如果使用 PostgreSQL
sudo systemctl status postgresql

# 如果使用 Supabase，检查连接字符串
```

### 问题5：内存不足

**检查内存使用：**
```bash
free -h
```

**如果内存不足：**
- 增加服务器内存
- 优化代码减少内存使用
- 设置 PM2 内存限制：`pm2 start index.js --name aigc-agent --max-memory-restart 1G`

## 预防措施

### 1. 设置 PM2 自动重启
```bash
pm2 start index.js --name aigc-agent --autorestart --max-memory-restart 1G
pm2 save
pm2 startup
```

### 2. 设置系统服务（可选）

创建 systemd 服务文件：
```bash
sudo nano /etc/systemd/system/aigc-agent.service
```

内容：
```ini
[Unit]
Description=AIGC Agent Backend
After=network.target postgresql.service

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/var/www/aigc-agent/server
ExecStart=/usr/bin/node index.js
Restart=always
RestartSec=10
Environment=NODE_ENV=production

[Install]
WantedBy=multi-user.target
```

启用服务：
```bash
sudo systemctl enable aigc-agent
sudo systemctl start aigc-agent
```

### 3. 监控服务状态

**设置定期检查脚本：**
```bash
# 创建监控脚本
cat > /home/ubuntu/check-backend.sh << 'EOF'
#!/bin/bash
if ! curl -s --max-time 5 http://localhost:3002/api/health > /dev/null; then
    cd /var/www/aigc-agent/server
    pm2 restart aigc-agent
    echo "$(date): Backend service restarted" >> /home/ubuntu/backend-monitor.log
fi
EOF

chmod +x /home/ubuntu/check-backend.sh

# 添加到 crontab（每5分钟检查一次）
(crontab -l 2>/dev/null; echo "*/5 * * * * /home/ubuntu/check-backend.sh") | crontab -
```

## 验证修复

修复后，在浏览器中：
1. 刷新登录页面
2. 尝试登录
3. 检查浏览器控制台是否还有 502 错误

如果问题仍然存在，请：
1. 查看 PM2 日志：`pm2 logs aigc-agent`
2. 查看 Nginx 错误日志：`sudo tail -f /var/log/nginx/error.log`
3. 检查服务器资源使用：`htop` 或 `top`




