# 修复 502 错误 - 问题总结和解决方案

## 发现的问题

从 PM2 日志中发现了以下问题：

### 1. ✅ 已修复：数据库连接错误
**错误信息：** `TypeError: Cannot read properties of undefined (reading 'query')`  
**位置：** `server/services/musicStorageService.js:233`  
**原因：** `connection.js` 使用默认导出 (`export default pool`)，但代码尝试使用命名导出 (`const { db } = await import(...)`)  
**修复：** 已更新 `getUserMusicList`、`saveMusicToDatabase` 和 `deleteMusic` 函数，使用 `pool.default || pool` 来获取数据库连接

### 2. ⚠️ 需要配置：API Key 缺失
**错误信息：** `SEEDREAM-4-0_API_KEY 环境变量未设置`  
**位置：** `server/services/seedreamService.js`  
**解决方案：** 在 `server/.env` 文件中添加 `SEEDREAM-4-0_API_KEY`（如果不需要使用该模型，可以忽略此错误）

### 3. ⚠️ 需要调查：语法错误
**错误信息：** `SyntaxError: Missing initializer in const declaration`  
**说明：** 这个错误重复出现，可能是在某个被导入的模块文件中  
**建议：** 使用 `node --check` 检查所有服务文件的语法

## 修复步骤

### 步骤1：更新代码到服务器

**方法1：使用 Git（推荐）**
```bash
# 在本地
cd C:\Users\Administrator\Desktop\AIGC-jubianage-agent
git add server/services/musicStorageService.js
git commit -m "修复 musicStorageService 数据库连接问题"
git push origin main

# 在服务器上
ssh ubuntu@119.45.121.152
cd /var/www/aigc-agent
git pull origin main
```

**方法2：直接复制文件**
```bash
# 使用 SCP 复制修复后的文件
scp server/services/musicStorageService.js ubuntu@119.45.121.152:/var/www/aigc-agent/server/services/
```

### 步骤2：重启服务

```bash
ssh ubuntu@119.45.121.152
cd /var/www/aigc-agent/server
pm2 restart aigc-agent
```

### 步骤3：验证修复

```bash
# 检查服务状态
pm2 list

# 测试健康检查
curl http://localhost:3002/api/health

# 查看日志
pm2 logs aigc-agent --lines 20
```

## 如果问题仍然存在

### 检查语法错误

```bash
cd /var/www/aigc-agent/server

# 检查主文件
node --check index.js

# 检查所有服务文件
for file in services/*.js; do
    echo "检查: $file"
    node --check "$file" 2>&1 | grep -i "syntax\|error" || echo "  ✅ 无语法错误"
done
```

### 完全重启服务

```bash
cd /var/www/aigc-agent/server
pm2 stop aigc-agent
pm2 delete aigc-agent
pm2 start index.js --name aigc-agent --autorestart --max-memory-restart 1G
pm2 save
```

### 查看详细日志

```bash
# 查看所有日志
pm2 logs aigc-agent --lines 100

# 只查看错误日志
pm2 logs aigc-agent --err --lines 100
```

## 预防措施

1. **设置 PM2 自动重启**
   ```bash
   pm2 start index.js --name aigc-agent --autorestart --max-memory-restart 1G
   pm2 save
   ```

2. **定期检查服务状态**
   ```bash
   # 添加到 crontab（每5分钟检查一次）
   */5 * * * * curl -s http://localhost:3002/api/health || cd /var/www/aigc-agent/server && pm2 restart aigc-agent
   ```

3. **监控日志**
   ```bash
   # 实时查看日志
   pm2 logs aigc-agent
   ```

## 已修复的文件

- ✅ `server/services/musicStorageService.js` - 修复数据库连接问题

## 需要手动配置

- ⚠️ `server/.env` - 添加 `SEEDREAM-4-0_API_KEY`（如果使用 Seedream 4.0 模型）




