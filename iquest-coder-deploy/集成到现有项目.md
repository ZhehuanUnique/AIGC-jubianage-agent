# ğŸ”Œ å°† IQuest-Coder é›†æˆåˆ°ä½ çš„ AIGC é¡¹ç›®

## ğŸ“‹ é›†æˆæ–¹æ¡ˆ

ä½ çš„é¡¹ç›®å·²ç»æœ‰äº†å®Œå–„çš„åç«¯æ¶æ„ï¼ˆExpress + PostgreSQLï¼‰ï¼Œå¯ä»¥è½»æ¾é›†æˆ IQuest-Coder APIã€‚

## ğŸ¯ é›†æˆæ­¥éª¤

### 1. åˆ›å»º IQuest-Coder æœåŠ¡æ¨¡å—

åœ¨ `server/services/` ç›®å½•ä¸‹åˆ›å»º `iquestCoderService.js`ï¼š

```javascript
// server/services/iquestCoderService.js
import axios from 'axios'

const IQUEST_CODER_API_BASE = process.env.IQUEST_CODER_API_BASE || 'http://localhost:8000/v1'
const IQUEST_CODER_MODEL = 'IQuestLab/IQuest-Coder-V1-40B-Loop-Instruct'

/**
 * IQuest-Coder AI ä»£ç åŠ©æ‰‹æœåŠ¡
 */
class IQuestCoderService {
  constructor() {
    this.client = axios.create({
      baseURL: IQUEST_CODER_API_BASE,
      headers: {
        'Content-Type': 'application/json'
      },
      timeout: 300000 // 5åˆ†é’Ÿè¶…æ—¶
    })
  }

  /**
   * ç”Ÿæˆä»£ç 
   * @param {string} prompt - ä»£ç ç”Ÿæˆæç¤ºè¯
   * @param {Object} options - å¯é€‰å‚æ•°
   * @returns {Promise<string>} ç”Ÿæˆçš„ä»£ç 
   */
  async generateCode(prompt, options = {}) {
    try {
      const response = await this.client.post('/chat/completions', {
        model: IQUEST_CODER_MODEL,
        messages: [
          { role: 'user', content: prompt }
        ],
        temperature: options.temperature || 0.6,
        top_p: options.top_p || 0.85,
        max_tokens: options.max_tokens || 4096,
        stream: false
      })

      return response.data.choices[0].message.content
    } catch (error) {
      console.error('IQuest-Coder ä»£ç ç”Ÿæˆå¤±è´¥:', error.message)
      throw new Error(`ä»£ç ç”Ÿæˆå¤±è´¥: ${error.message}`)
    }
  }

  /**
   * ä»£ç å®¡æŸ¥
   * @param {string} code - è¦å®¡æŸ¥çš„ä»£ç 
   * @returns {Promise<string>} å®¡æŸ¥ç»“æœ
   */
  async reviewCode(code) {
    const prompt = `è¯·å®¡æŸ¥ä»¥ä¸‹ä»£ç ï¼ŒæŒ‡å‡ºå¯ä»¥æ”¹è¿›çš„åœ°æ–¹ï¼š\n\n\`\`\`\n${code}\n\`\`\``
    return this.generateCode(prompt, { max_tokens: 2048 })
  }

  /**
   * Bug ä¿®å¤
   * @param {string} code - æœ‰é—®é¢˜çš„ä»£ç 
   * @param {string} error - é”™è¯¯ä¿¡æ¯
   * @returns {Promise<string>} ä¿®å¤å»ºè®®
   */
  async fixBug(code, error) {
    const prompt = `ä»¥ä¸‹ä»£ç å‡ºç°é”™è¯¯ï¼š\n\n\`\`\`\n${code}\n\`\`\`\n\né”™è¯¯ä¿¡æ¯ï¼š\n${error}\n\nè¯·åˆ†æé—®é¢˜å¹¶æä¾›ä¿®å¤æ–¹æ¡ˆã€‚`
    return this.generateCode(prompt, { max_tokens: 2048 })
  }

  /**
   * ä»£ç è§£é‡Š
   * @param {string} code - è¦è§£é‡Šçš„ä»£ç 
   * @returns {Promise<string>} ä»£ç è§£é‡Š
   */
  async explainCode(code) {
    const prompt = `è¯·è¯¦ç»†è§£é‡Šä»¥ä¸‹ä»£ç çš„åŠŸèƒ½å’Œå®ç°åŸç†ï¼š\n\n\`\`\`\n${code}\n\`\`\``
    return this.generateCode(prompt, { max_tokens: 2048 })
  }

  /**
   * æµå¼ç”Ÿæˆä»£ç 
   * @param {string} prompt - ä»£ç ç”Ÿæˆæç¤ºè¯
   * @param {Function} onChunk - æ¥æ”¶æ¯ä¸ªæ•°æ®å—çš„å›è°ƒå‡½æ•°
   * @param {Object} options - å¯é€‰å‚æ•°
   */
  async generateCodeStream(prompt, onChunk, options = {}) {
    try {
      const response = await this.client.post('/chat/completions', {
        model: IQUEST_CODER_MODEL,
        messages: [
          { role: 'user', content: prompt }
        ],
        temperature: options.temperature || 0.6,
        top_p: options.top_p || 0.85,
        max_tokens: options.max_tokens || 4096,
        stream: true
      }, {
        responseType: 'stream'
      })

      return new Promise((resolve, reject) => {
        let fullContent = ''

        response.data.on('data', (chunk) => {
          const lines = chunk.toString().split('\n').filter(line => line.trim())
          
          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = line.slice(6)
              if (data === '[DONE]') {
                resolve(fullContent)
                return
              }
              
              try {
                const parsed = JSON.parse(data)
                const content = parsed.choices[0]?.delta?.content || ''
                if (content) {
                  fullContent += content
                  onChunk(content)
                }
              } catch (e) {
                // å¿½ç•¥è§£æé”™è¯¯
              }
            }
          }
        })

        response.data.on('error', reject)
      })
    } catch (error) {
      console.error('IQuest-Coder æµå¼ç”Ÿæˆå¤±è´¥:', error.message)
      throw new Error(`æµå¼ç”Ÿæˆå¤±è´¥: ${error.message}`)
    }
  }

  /**
   * å¥åº·æ£€æŸ¥
   * @returns {Promise<boolean>} æœåŠ¡æ˜¯å¦å¥åº·
   */
  async healthCheck() {
    try {
      const response = await axios.get(IQUEST_CODER_API_BASE.replace('/v1', '/health'))
      return response.status === 200
    } catch (error) {
      return false
    }
  }
}

export const iquestCoderService = new IQuestCoderService()
```

### 2. æ·»åŠ ç¯å¢ƒå˜é‡

åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ ï¼š

```bash
# IQuest-Coder API é…ç½®
IQUEST_CODER_API_BASE=http://localhost:8000/v1
# å¦‚æœéƒ¨ç½²åœ¨å…¶ä»–æœåŠ¡å™¨ï¼Œä¿®æ”¹ä¸ºï¼š
# IQUEST_CODER_API_BASE=http://ä½ çš„æœåŠ¡å™¨IP:8000/v1
```

### 3. åˆ›å»º API è·¯ç”±

åœ¨ `server/index.js` ä¸­æ·»åŠ è·¯ç”±ï¼š

```javascript
import { iquestCoderService } from './services/iquestCoderService.js'

// ==================== IQuest-Coder AI ä»£ç åŠ©æ‰‹ API ====================

// ä»£ç ç”Ÿæˆ
app.post('/api/iquest-coder/generate', authenticateToken, async (req, res) => {
  try {
    const { prompt, temperature, top_p, max_tokens } = req.body

    if (!prompt) {
      return res.status(400).json({
        success: false,
        error: 'æç¤ºè¯ä¸èƒ½ä¸ºç©º'
      })
    }

    const code = await iquestCoderService.generateCode(prompt, {
      temperature,
      top_p,
      max_tokens
    })

    res.json({
      success: true,
      data: { code }
    })
  } catch (error) {
    console.error('ä»£ç ç”Ÿæˆå¤±è´¥:', error)
    res.status(500).json({
      success: false,
      error: error.message
    })
  }
})

// ä»£ç å®¡æŸ¥
app.post('/api/iquest-coder/review', authenticateToken, async (req, res) => {
  try {
    const { code } = req.body

    if (!code) {
      return res.status(400).json({
        success: false,
        error: 'ä»£ç ä¸èƒ½ä¸ºç©º'
      })
    }

    const review = await iquestCoderService.reviewCode(code)

    res.json({
      success: true,
      data: { review }
    })
  } catch (error) {
    console.error('ä»£ç å®¡æŸ¥å¤±è´¥:', error)
    res.status(500).json({
      success: false,
      error: error.message
    })
  }
})

// Bug ä¿®å¤
app.post('/api/iquest-coder/fix-bug', authenticateToken, async (req, res) => {
  try {
    const { code, error: errorMsg } = req.body

    if (!code || !errorMsg) {
      return res.status(400).json({
        success: false,
        error: 'ä»£ç å’Œé”™è¯¯ä¿¡æ¯ä¸èƒ½ä¸ºç©º'
      })
    }

    const fix = await iquestCoderService.fixBug(code, errorMsg)

    res.json({
      success: true,
      data: { fix }
    })
  } catch (error) {
    console.error('Bug ä¿®å¤å¤±è´¥:', error)
    res.status(500).json({
      success: false,
      error: error.message
    })
  }
})

// ä»£ç è§£é‡Š
app.post('/api/iquest-coder/explain', authenticateToken, async (req, res) => {
  try {
    const { code } = req.body

    if (!code) {
      return res.status(400).json({
        success: false,
        error: 'ä»£ç ä¸èƒ½ä¸ºç©º'
      })
    }

    const explanation = await iquestCoderService.explainCode(code)

    res.json({
      success: true,
      data: { explanation }
    })
  } catch (error) {
    console.error('ä»£ç è§£é‡Šå¤±è´¥:', error)
    res.status(500).json({
      success: false,
      error: error.message
    })
  }
})

// æµå¼ä»£ç ç”Ÿæˆ
app.post('/api/iquest-coder/generate-stream', authenticateToken, async (req, res) => {
  try {
    const { prompt, temperature, top_p, max_tokens } = req.body

    if (!prompt) {
      return res.status(400).json({
        success: false,
        error: 'æç¤ºè¯ä¸èƒ½ä¸ºç©º'
      })
    }

    // è®¾ç½® SSE å“åº”å¤´
    res.setHeader('Content-Type', 'text/event-stream')
    res.setHeader('Cache-Control', 'no-cache')
    res.setHeader('Connection', 'keep-alive')

    await iquestCoderService.generateCodeStream(
      prompt,
      (chunk) => {
        res.write(`data: ${JSON.stringify({ chunk })}\n\n`)
      },
      { temperature, top_p, max_tokens }
    )

    res.write('data: [DONE]\n\n')
    res.end()
  } catch (error) {
    console.error('æµå¼ä»£ç ç”Ÿæˆå¤±è´¥:', error)
    res.write(`data: ${JSON.stringify({ error: error.message })}\n\n`)
    res.end()
  }
})

// å¥åº·æ£€æŸ¥
app.get('/api/iquest-coder/health', async (req, res) => {
  try {
    const isHealthy = await iquestCoderService.healthCheck()
    res.json({
      success: true,
      data: { healthy: isHealthy }
    })
  } catch (error) {
    res.status(500).json({
      success: false,
      error: error.message
    })
  }
})
```

### 4. å‰ç«¯é›†æˆç¤ºä¾‹

åˆ›å»º `src/services/iquestCoderApi.ts`ï¼š

```typescript
// src/services/iquestCoderApi.ts
import axios from 'axios'

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3002'

export interface GenerateCodeRequest {
  prompt: string
  temperature?: number
  top_p?: number
  max_tokens?: number
}

export interface CodeReviewRequest {
  code: string
}

export interface BugFixRequest {
  code: string
  error: string
}

export const iquestCoderApi = {
  /**
   * ç”Ÿæˆä»£ç 
   */
  async generateCode(data: GenerateCodeRequest) {
    const response = await axios.post(`${API_BASE_URL}/api/iquest-coder/generate`, data)
    return response.data
  },

  /**
   * ä»£ç å®¡æŸ¥
   */
  async reviewCode(data: CodeReviewRequest) {
    const response = await axios.post(`${API_BASE_URL}/api/iquest-coder/review`, data)
    return response.data
  },

  /**
   * Bug ä¿®å¤
   */
  async fixBug(data: BugFixRequest) {
    const response = await axios.post(`${API_BASE_URL}/api/iquest-coder/fix-bug`, data)
    return response.data
  },

  /**
   * ä»£ç è§£é‡Š
   */
  async explainCode(data: CodeReviewRequest) {
    const response = await axios.post(`${API_BASE_URL}/api/iquest-coder/explain`, data)
    return response.data
  },

  /**
   * æµå¼ç”Ÿæˆä»£ç 
   */
  async generateCodeStream(
    data: GenerateCodeRequest,
    onChunk: (chunk: string) => void
  ) {
    const response = await fetch(`${API_BASE_URL}/api/iquest-coder/generate-stream`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      },
      body: JSON.stringify(data)
    })

    const reader = response.body?.getReader()
    const decoder = new TextDecoder()

    while (true) {
      const { done, value } = await reader!.read()
      if (done) break

      const chunk = decoder.decode(value)
      const lines = chunk.split('\n').filter(line => line.trim())

      for (const line of lines) {
        if (line.startsWith('data: ')) {
          const data = line.slice(6)
          if (data === '[DONE]') return

          try {
            const parsed = JSON.parse(data)
            if (parsed.chunk) {
              onChunk(parsed.chunk)
            }
          } catch (e) {
            // å¿½ç•¥è§£æé”™è¯¯
          }
        }
      }
    }
  },

  /**
   * å¥åº·æ£€æŸ¥
   */
  async healthCheck() {
    const response = await axios.get(`${API_BASE_URL}/api/iquest-coder/health`)
    return response.data
  }
}
```

### 5. åˆ›å»º React ç»„ä»¶ç¤ºä¾‹

```typescript
// src/components/CodeAssistant.tsx
import { useState } from 'react'
import { iquestCoderApi } from '../services/iquestCoderApi'

export function CodeAssistant() {
  const [prompt, setPrompt] = useState('')
  const [code, setCode] = useState('')
  const [loading, setLoading] = useState(false)

  const handleGenerate = async () => {
    if (!prompt.trim()) return

    setLoading(true)
    try {
      const result = await iquestCoderApi.generateCode({ prompt })
      setCode(result.data.code)
    } catch (error) {
      console.error('ç”Ÿæˆå¤±è´¥:', error)
      alert('ç”Ÿæˆå¤±è´¥ï¼Œè¯·é‡è¯•')
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="code-assistant">
      <h2>AI ä»£ç åŠ©æ‰‹</h2>
      
      <div className="input-section">
        <textarea
          value={prompt}
          onChange={(e) => setPrompt(e.target.value)}
          placeholder="æè¿°ä½ æƒ³è¦ç”Ÿæˆçš„ä»£ç ..."
          rows={4}
        />
        <button onClick={handleGenerate} disabled={loading}>
          {loading ? 'ç”Ÿæˆä¸­...' : 'ç”Ÿæˆä»£ç '}
        </button>
      </div>

      {code && (
        <div className="output-section">
          <h3>ç”Ÿæˆçš„ä»£ç ï¼š</h3>
          <pre><code>{code}</code></pre>
        </div>
      )}
    </div>
  )
}
```

## ğŸ¯ ä½¿ç”¨åœºæ™¯

### 1. å‰§æœ¬åˆ†æå¢å¼º
åœ¨å‰§æœ¬åˆ†ææ—¶ï¼Œä½¿ç”¨ IQuest-Coder ç”Ÿæˆæ›´æ™ºèƒ½çš„åˆ†é•œæç¤ºè¯ï¼š

```javascript
// åœ¨ scriptAnalyzer.js ä¸­é›†æˆ
import { iquestCoderService } from './iquestCoderService.js'

async function generateSmartPrompt(sceneDescription) {
  const prompt = `æ ¹æ®ä»¥ä¸‹åœºæ™¯æè¿°ï¼Œç”Ÿæˆä¸€ä¸ªè¯¦ç»†çš„è§†é¢‘ç”Ÿæˆæç¤ºè¯ï¼š\n${sceneDescription}`
  return await iquestCoderService.generateCode(prompt)
}
```

### 2. ä»£ç è¾…åŠ©å·¥å…·
ä¸ºå¼€å‘è€…æä¾›ä»£ç ç”Ÿæˆã€å®¡æŸ¥ã€ä¿®å¤åŠŸèƒ½ã€‚

### 3. æ™ºèƒ½é—®ç­”
å›ç­”ç”¨æˆ·å…³äºä»£ç ã€æŠ€æœ¯çš„é—®é¢˜ã€‚

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

åœ¨ `server/index.js` ä¸­æ·»åŠ æ—¥å¿—è®°å½•ï¼š

```javascript
// è®°å½• IQuest-Coder API è°ƒç”¨
app.use('/api/iquest-coder/*', (req, res, next) => {
  console.log(`IQuest-Coder API è°ƒç”¨: ${req.method} ${req.path}`)
  next()
})
```

## âœ… é›†æˆå®Œæˆæ£€æŸ¥æ¸…å•

- [ ] IQuest-Coder æœåŠ¡å·²éƒ¨ç½²å¹¶è¿è¡Œ
- [ ] æœåŠ¡æ¨¡å—å·²åˆ›å»ºï¼ˆiquestCoderService.jsï¼‰
- [ ] ç¯å¢ƒå˜é‡å·²é…ç½®
- [ ] API è·¯ç”±å·²æ·»åŠ 
- [ ] å‰ç«¯ API æœåŠ¡å·²åˆ›å»º
- [ ] æµ‹è¯•é€šè¿‡

æ­å–œï¼ä½ å·²ç»æˆåŠŸå°† IQuest-Coder é›†æˆåˆ°ä½ çš„é¡¹ç›®ä¸­ï¼ğŸ‰
