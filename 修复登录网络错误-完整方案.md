# 修复登录网络错误 - 完整方案

## 问题分析

登录页面显示"网络错误,请稍后重试"，可能的原因：
1. 后端服务未运行
2. 后端服务有语法错误导致无法启动
3. API 路径配置错误
4. Nginx 配置问题

## 解决步骤

### 步骤 1: 检查服务器状态

在服务器上执行：

```bash
# 1. 检查 PM2 服务状态
pm2 status

# 2. 查看错误日志
pm2 logs aigc-agent --lines 50 --err

# 3. 测试后端服务
curl http://localhost:3002/api/health
```

### 步骤 2: 检查语法错误

```bash
cd /var/www/aigc-agent/server

# 配置 Node.js PATH
export PATH="/home/ubuntu/.nvm/versions/node/v20.19.6/bin:$PATH"

# 检查所有文件语法
for file in index.js services/*.js; do
    if [ -f "$file" ]; then
        echo "检查: $file"
        node --check "$file" || echo "  ❌ 有错误"
    fi
done
```

### 步骤 3: 修复语法错误

如果发现语法错误，通常是 `const` 声明缺少初始化值，例如：
- ❌ `const x;` （错误）
- ✅ `const x = value;` （正确）

### 步骤 4: 重启服务

```bash
# 重启 PM2 服务
pm2 restart aigc-agent

# 等待几秒
sleep 3

# 检查状态
pm2 status aigc-agent

# 查看日志
pm2 logs aigc-agent --lines 20
```

### 步骤 5: 验证服务

```bash
# 测试本地连接
curl http://localhost:3002/api/health

# 测试通过 Nginx
curl http://localhost/api/health

# 检查 Nginx 状态
sudo systemctl status nginx
```

## 快速修复命令（一键执行）

```bash
ssh ubuntu@119.45.121.152 << 'EOF'
cd /var/www/aigc-agent

# 配置 PATH
export PATH="/home/ubuntu/.nvm/versions/node/v20.19.6/bin:$PATH"
if [ -s "$HOME/.nvm/nvm.sh" ]; then
    export NVM_DIR="$HOME/.nvm"
    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
fi

# 检查语法
cd server
echo "检查语法错误..."
ERRORS=0
for file in index.js services/*.js; do
    if [ -f "$file" ] && ! node --check "$file" > /dev/null 2>&1; then
        echo "❌ 语法错误: $file"
        node --check "$file" 2>&1 | head -3
        ERRORS=$((ERRORS + 1))
    fi
done

if [ $ERRORS -eq 0 ]; then
    echo "✅ 语法检查通过"
    echo "重启服务..."
    pm2 restart aigc-agent
    sleep 3
    echo "检查服务状态..."
    pm2 status aigc-agent
    echo "测试健康检查..."
    curl -s http://localhost:3002/api/health && echo "✅ 服务正常" || echo "❌ 服务异常"
else
    echo "❌ 发现 $ERRORS 个语法错误，请先修复"
fi
EOF
```

## 常见问题

### 问题 1: PM2 服务状态为 errored

**解决方案：**
```bash
# 删除并重新启动
pm2 delete aigc-agent
cd /var/www/aigc-agent/server
pm2 start index.js --name aigc-agent
```

### 问题 2: 语法错误无法修复

**解决方案：**
1. 从 GitHub 拉取最新代码
2. 确保本地代码没有语法错误
3. 推送到服务器

### 问题 3: 服务启动但无法连接

**解决方案：**
1. 检查防火墙：`sudo ufw status`
2. 检查端口：`sudo netstat -tlnp | grep 3002`
3. 检查 Nginx 配置：`sudo nginx -t`

## 验证修复

修复后，在浏览器中：
1. 刷新登录页面
2. 尝试登录
3. 如果仍然显示"网络错误"，检查浏览器控制台（F12）的错误信息




