# è…¾è®¯äº‘ CVM éƒ¨ç½²å®Œæ•´æ­¥éª¤

## ğŸ“‹ æœåŠ¡å™¨ä¿¡æ¯

- **æœåŠ¡å™¨IP**ï¼š119.45.121.152
- **åŸŸå**ï¼šjubianai.cn
- **ç”¨æˆ·å**ï¼šubuntu
- **å¯†ç **ï¼šrXTg#!G$6c45yxZ
- **æ“ä½œç³»ç»Ÿ**ï¼šUbuntu 22.04 LTS

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šè¿æ¥åˆ°æœåŠ¡å™¨

åœ¨æœ¬åœ° PowerShell æˆ– CMD ä¸­æ‰§è¡Œï¼š

```bash
ssh ubuntu@119.45.121.152
```

è¾“å…¥å¯†ç ï¼š`rXTg#!G$6c45yxZ`

---

### ç¬¬äºŒæ­¥ï¼šå®‰è£…ç¯å¢ƒï¼ˆåœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼‰

#### 2.1 æ›´æ–°ç³»ç»Ÿ

```bash
sudo apt update && sudo apt upgrade -y
```

#### 2.2 å®‰è£… Node.jsï¼ˆä½¿ç”¨ NVMï¼‰

```bash
# å®‰è£… NVM
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash

# é‡æ–°åŠ è½½ shell é…ç½®
source ~/.bashrc

# å®‰è£… Node.js 20 LTS
nvm install 20
nvm use 20
nvm alias default 20

# éªŒè¯å®‰è£…
node -v  # åº”è¯¥æ˜¾ç¤º v20.x.x
npm -v   # åº”è¯¥æ˜¾ç¤º 10.x.x
```

#### 2.3 å®‰è£… PM2ï¼ˆè¿›ç¨‹ç®¡ç†ï¼‰

```bash
npm install -g pm2

# è®¾ç½® PM2 å¼€æœºè‡ªå¯
pm2 startup
# æŒ‰ç…§æç¤ºæ‰§è¡Œè¾“å‡ºçš„ sudo å‘½ä»¤
```

#### 2.4 å®‰è£… Nginxï¼ˆåå‘ä»£ç†ï¼‰

```bash
sudo apt install nginx -y
sudo systemctl start nginx
sudo systemctl enable nginx

# éªŒè¯ Nginx æ˜¯å¦è¿è¡Œ
sudo systemctl status nginx
```

#### 2.5 å®‰è£… Git

```bash
sudo apt install git -y
```

---

### ç¬¬ä¸‰æ­¥ï¼šéƒ¨ç½²åº”ç”¨ä»£ç 

#### 3.1 åˆ›å»ºé¡¹ç›®ç›®å½•

```bash
sudo mkdir -p /var/www/aigc-agent
sudo chown ubuntu:ubuntu /var/www/aigc-agent
```

#### 3.2 å…‹éš†ä»£ç 

```bash
cd /var/www/aigc-agent
git clone https://github.com/ZhehuanUnique/AIGC-jubianage-agent.git .
```

#### 3.3 å®‰è£…ä¾èµ–

```bash
# å®‰è£…å‰ç«¯ä¾èµ–
npm install

# å®‰è£…åç«¯ä¾èµ–
cd server
npm install
cd ..
```

#### 3.4 é…ç½®ç¯å¢ƒå˜é‡

```bash
cd server
cp env.example .env
nano .env
```

**éœ€è¦é…ç½®çš„ç¯å¢ƒå˜é‡**ï¼š

```env
# æœåŠ¡å™¨ç«¯å£
PORT=3002

# é€šä¹‰åƒé—® API å¯†é’¥ï¼ˆå¿…éœ€ï¼‰
DASHSCOPE_API_KEY=sk-your-api-key-here

# æ¨¡å‹é€‰æ‹©
QWEN_MODEL=qwen-plus

# Supabase æ•°æ®åº“è¿æ¥ï¼ˆå¿…éœ€ï¼‰
# ä½¿ç”¨ Supabase è¿æ¥å­—ç¬¦ä¸²
DATABASE_URL=postgresql://postgres.ogndfzxtzsifaqwzfojs:your-password@aws-0-ap-southeast-1.pooler.supabase.com:6543/postgres

# è…¾è®¯äº‘ COS é…ç½®ï¼ˆå¿…éœ€ï¼‰
COS_SECRET_ID=your-secret-id
COS_SECRET_KEY=your-secret-key
COS_REGION=ap-guangzhou
COS_BUCKET=your-bucket-name

# JWT å¯†é’¥ï¼ˆå¿…éœ€ï¼‰
JWT_SECRET=your-jwt-secret-key-here

# å…¶ä»–å¯é€‰é…ç½®
# NANO_BANANA_API_KEY=...
# MIDJOURNEY_API_KEY=...
# SUNO_API_KEY=...
```

**ä¿å­˜æ–‡ä»¶**ï¼šæŒ‰ `Ctrl + X`ï¼Œç„¶åæŒ‰ `Y`ï¼Œæœ€åæŒ‰ `Enter`

#### 3.5 æ„å»ºå‰ç«¯

```bash
cd /var/www/aigc-agent
npm run build
```

#### 3.6 å¯åŠ¨åç«¯æœåŠ¡

```bash
cd /var/www/aigc-agent/server
pm2 start index.js --name aigc-agent
pm2 save
pm2 startup  # å¦‚æœä¹‹å‰æ²¡æœ‰æ‰§è¡Œï¼Œç°åœ¨æ‰§è¡Œ
```

**éªŒè¯æœåŠ¡**ï¼š

```bash
# æŸ¥çœ‹ PM2 çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs aigc-agent

# æµ‹è¯•åç«¯ API
curl http://localhost:3002/health
```

---

### ç¬¬å››æ­¥ï¼šé…ç½® Nginx

#### 4.1 åˆ›å»º Nginx é…ç½®æ–‡ä»¶

```bash
sudo nano /etc/nginx/sites-available/aigc-agent
```

#### 4.2 å†™å…¥é…ç½®å†…å®¹

```nginx
server {
    listen 80;
    server_name jubianai.cn www.jubianai.cn;

    # å‰ç«¯é™æ€æ–‡ä»¶
    location / {
        root /var/www/aigc-agent/dist;
        try_files $uri $uri/ /index.html;
        index index.html;
    }

    # åç«¯ API
    location /api {
        proxy_pass http://localhost:3002;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # å¢åŠ è¶…æ—¶æ—¶é—´
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # é™æ€èµ„æºç¼“å­˜
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        root /var/www/aigc-agent/dist;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
```

**ä¿å­˜æ–‡ä»¶**ï¼šæŒ‰ `Ctrl + X`ï¼Œç„¶åæŒ‰ `Y`ï¼Œæœ€åæŒ‰ `Enter`

#### 4.3 å¯ç”¨é…ç½®

```bash
# åˆ›å»ºç¬¦å·é“¾æ¥
sudo ln -s /etc/nginx/sites-available/aigc-agent /etc/nginx/sites-enabled/

# åˆ é™¤é»˜è®¤é…ç½®ï¼ˆå¯é€‰ï¼‰
sudo rm /etc/nginx/sites-enabled/default

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡æ–°åŠ è½½ Nginx
sudo systemctl reload nginx
```

---

### ç¬¬äº”æ­¥ï¼šé…ç½® SSLï¼ˆHTTPSï¼‰

#### 5.1 å®‰è£… Certbot

```bash
sudo apt install certbot python3-certbot-nginx -y
```

#### 5.2 è·å– SSL è¯ä¹¦

```bash
sudo certbot --nginx -d jubianai.cn -d www.jubianai.cn
```

**æŒ‰ç…§æç¤ºæ“ä½œ**ï¼š
1. è¾“å…¥é‚®ç®±åœ°å€
2. åŒæ„æœåŠ¡æ¡æ¬¾
3. é€‰æ‹©æ˜¯å¦åˆ†äº«é‚®ç®±ï¼ˆå¯é€‰ï¼‰
4. é€‰æ‹©æ˜¯å¦é‡å®šå‘ HTTP åˆ° HTTPSï¼ˆæ¨èé€‰æ‹© 2ï¼šé‡å®šå‘ï¼‰

#### 5.3 éªŒè¯è‡ªåŠ¨ç»­æœŸ

```bash
sudo certbot renew --dry-run
```

---

### ç¬¬å…­æ­¥ï¼šé…ç½®é˜²ç«å¢™

#### 6.1 å¼€æ”¾å¿…è¦ç«¯å£

```bash
# æŸ¥çœ‹é˜²ç«å¢™çŠ¶æ€
sudo ufw status

# å¼€æ”¾ç«¯å£
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS

# å¯ç”¨é˜²ç«å¢™
sudo ufw enable

# æŸ¥çœ‹çŠ¶æ€
sudo ufw status
```

---

### ç¬¬ä¸ƒæ­¥ï¼šéªŒè¯éƒ¨ç½²

#### 7.1 æ£€æŸ¥æœåŠ¡çŠ¶æ€

```bash
# æ£€æŸ¥ PM2 è¿›ç¨‹
pm2 status

# æ£€æŸ¥ Nginx çŠ¶æ€
sudo systemctl status nginx

# æ£€æŸ¥åç«¯ API
curl http://localhost:3002/health
```

#### 7.2 è®¿é—®ç½‘ç«™

- **HTTP**ï¼šhttp://jubianai.cn
- **HTTPS**ï¼šhttps://jubianai.cnï¼ˆé…ç½® SSL åï¼‰

---

## ğŸ”§ å¸¸ç”¨ç®¡ç†å‘½ä»¤

### PM2 ç®¡ç†

```bash
# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs aigc-agent

# é‡å¯åº”ç”¨
pm2 restart aigc-agent

# åœæ­¢åº”ç”¨
pm2 stop aigc-agent

# åˆ é™¤åº”ç”¨
pm2 delete aigc-agent

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
pm2 info aigc-agent
```

### Nginx ç®¡ç†

```bash
# å¯åŠ¨
sudo systemctl start nginx

# åœæ­¢
sudo systemctl stop nginx

# é‡å¯
sudo systemctl restart nginx

# é‡æ–°åŠ è½½é…ç½®
sudo systemctl reload nginx

# æŸ¥çœ‹çŠ¶æ€
sudo systemctl status nginx

# æŸ¥çœ‹æ—¥å¿—
sudo tail -f /var/log/nginx/error.log
sudo tail -f /var/log/nginx/access.log
```

### æ›´æ–°ä»£ç 

```bash
cd /var/www/aigc-agent

# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# å®‰è£…æ–°ä¾èµ–ï¼ˆå¦‚æœæœ‰ï¼‰
npm install
cd server
npm install
cd ..

# é‡æ–°æ„å»ºå‰ç«¯
npm run build

# é‡å¯åº”ç”¨
pm2 restart aigc-agent
```

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1ï¼šæ— æ³•è¿æ¥æœåŠ¡å™¨

**æ£€æŸ¥**ï¼š
- ç¡®è®¤æœåŠ¡å™¨ IP åœ°å€æ­£ç¡®
- ç¡®è®¤å¯†ç æ­£ç¡®
- æ£€æŸ¥æœ¬åœ°ç½‘ç»œè¿æ¥
- æ£€æŸ¥è…¾è®¯äº‘å®‰å…¨ç»„æ˜¯å¦å¼€æ”¾ 22 ç«¯å£

### é—®é¢˜ 2ï¼šPM2 æœåŠ¡æ— æ³•å¯åŠ¨

**æ£€æŸ¥**ï¼š
```bash
# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
pm2 logs aigc-agent --lines 50

# æ£€æŸ¥ç¯å¢ƒå˜é‡
cd /var/www/aigc-agent/server
cat .env

# æ‰‹åŠ¨å¯åŠ¨æµ‹è¯•
node index.js
```

### é—®é¢˜ 3ï¼šNginx 502 é”™è¯¯

**æ£€æŸ¥**ï¼š
- ç¡®è®¤åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œï¼š`pm2 status`
- ç¡®è®¤ç«¯å£ 3002 æ­£ç¡®ï¼š`curl http://localhost:3002/health`
- æŸ¥çœ‹ Nginx é”™è¯¯æ—¥å¿—ï¼š`sudo tail -f /var/log/nginx/error.log`

### é—®é¢˜ 4ï¼šç½‘ç«™æ— æ³•è®¿é—®

**æ£€æŸ¥**ï¼š
- ç¡®è®¤åŸŸå DNS è§£ææ­£ç¡®ï¼š`ping jubianai.cn`
- ç¡®è®¤é˜²ç«å¢™å·²å¼€æ”¾ 80/443 ç«¯å£
- ç¡®è®¤ Nginx é…ç½®æ­£ç¡®ï¼š`sudo nginx -t`
- æ£€æŸ¥ Nginx çŠ¶æ€ï¼š`sudo systemctl status nginx`

### é—®é¢˜ 5ï¼šSSL è¯ä¹¦é—®é¢˜

**æ£€æŸ¥**ï¼š
- ç¡®è®¤åŸŸå DNS å·²æ­£ç¡®è§£æåˆ°æœåŠ¡å™¨ IP
- ç¡®è®¤ 80 ç«¯å£å¯è®¿é—®ï¼ˆCertbot éœ€è¦ï¼‰
- æŸ¥çœ‹è¯ä¹¦çŠ¶æ€ï¼š`sudo certbot certificates`
- æ‰‹åŠ¨ç»­æœŸï¼š`sudo certbot renew`

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ç¯å¢ƒå˜é‡å®‰å…¨**ï¼šç¡®ä¿ `.env` æ–‡ä»¶ä¸è¢«æäº¤åˆ° Git
2. **å®šæœŸå¤‡ä»½**ï¼šå®šæœŸå¤‡ä»½æ•°æ®åº“å’Œé‡è¦æ–‡ä»¶
3. **ç›‘æ§èµ„æº**ï¼šä½¿ç”¨ `htop` æˆ– `top` ç›‘æ§æœåŠ¡å™¨èµ„æºä½¿ç”¨
4. **æ—¥å¿—ç®¡ç†**ï¼šå®šæœŸæ¸…ç†æ—¥å¿—æ–‡ä»¶ï¼Œé¿å…ç£ç›˜ç©ºé—´ä¸è¶³
5. **å®‰å…¨æ›´æ–°**ï¼šå®šæœŸæ›´æ–°ç³»ç»Ÿå’Œä¾èµ–åŒ…

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] æœåŠ¡å™¨å·²è´­ä¹°å¹¶é…ç½®
- [ ] åŸŸåå·²è§£æåˆ°æœåŠ¡å™¨ IP
- [ ] Node.js å’Œ PM2 å·²å®‰è£…
- [ ] Nginx å·²å®‰è£…å¹¶é…ç½®
- [ ] ä»£ç å·²å…‹éš†åˆ°æœåŠ¡å™¨
- [ ] ç¯å¢ƒå˜é‡å·²é…ç½®
- [ ] å‰ç«¯å·²æ„å»º
- [ ] åç«¯æœåŠ¡å·²å¯åŠ¨
- [ ] Nginx é…ç½®å·²ç”Ÿæ•ˆ
- [ ] SSL è¯ä¹¦å·²é…ç½®ï¼ˆå¯é€‰ï¼‰
- [ ] é˜²ç«å¢™å·²é…ç½®
- [ ] ç½‘ç«™å¯ä»¥æ­£å¸¸è®¿é—®

---

## ğŸ“ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œå¯ä»¥ï¼š
1. æŸ¥çœ‹ PM2 æ—¥å¿—ï¼š`pm2 logs aigc-agent`
2. æŸ¥çœ‹ Nginx æ—¥å¿—ï¼š`sudo tail -f /var/log/nginx/error.log`
3. æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼š`pm2 status` å’Œ `sudo systemctl status nginx`



