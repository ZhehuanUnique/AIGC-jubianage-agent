# 服务器部署完整步骤

## 步骤1: 拉取最新代码并部署

在服务器上执行以下命令：

```bash
# 方法1: 如果项目在 /home/ubuntu/ 目录
cd /home/ubuntu/AIGC-jubianage-agent
git pull origin main

# 方法2: 如果项目在 /root/ 目录（需要sudo）
sudo su -
cd /root/AIGC-jubianage-agent
git pull origin main
```

## 步骤2: 安装前端依赖并构建

```bash
cd src
npm install
npm run build
cd ..
```

## 步骤3: 安装后端依赖

```bash
cd server
npm install
cd ..
```

## 步骤4: 重启后端服务

```bash
pm2 restart AIGC-jubianage-agent || pm2 start server/index.js --name AIGC-jubianage-agent
pm2 status
```

## 步骤5: 执行数据库迁移（重要！）

**必须在Supabase SQL编辑器中执行以下SQL脚本：**

1. 登录Supabase控制台
2. 进入SQL Editor
3. 执行 `server/db/migrate_first_last_frame_videos.sql` 文件中的SQL

或者直接执行：

```sql
-- 创建首尾帧生成视频表
CREATE TABLE IF NOT EXISTS first_last_frame_videos (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  project_id INTEGER NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
  task_id VARCHAR(255) UNIQUE NOT NULL,
  video_url TEXT NOT NULL,
  cos_key TEXT NOT NULL,
  first_frame_url TEXT,
  last_frame_url TEXT,
  model VARCHAR(100) DEFAULT 'volcengine-video-3.0-pro',
  resolution VARCHAR(20) DEFAULT '720p',
  ratio VARCHAR(20) DEFAULT '16:9',
  duration INTEGER DEFAULT 5,
  prompt TEXT,
  text TEXT,
  status VARCHAR(50) DEFAULT 'pending',
  error_message TEXT,
  shot_id INTEGER REFERENCES shots(id) ON DELETE SET NULL,
  estimated_credit INTEGER,
  actual_credit INTEGER,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建索引
CREATE INDEX IF NOT EXISTS idx_first_last_frame_videos_user_id ON first_last_frame_videos(user_id);
CREATE INDEX IF NOT EXISTS idx_first_last_frame_videos_project_id ON first_last_frame_videos(project_id);
CREATE INDEX IF NOT EXISTS idx_first_last_frame_videos_task_id ON first_last_frame_videos(task_id);
CREATE INDEX IF NOT EXISTS idx_first_last_frame_videos_status ON first_last_frame_videos(status);
CREATE INDEX IF NOT EXISTS idx_first_last_frame_videos_created_at ON first_last_frame_videos(created_at DESC);
```

## 快速部署脚本

如果使用部署脚本：

```bash
chmod +x 服务器部署-首尾帧视频表.sh
./服务器部署-首尾帧视频表.sh
```

## 验证部署

1. 检查前端构建：`ls -la src/dist`
2. 检查后端服务：`pm2 logs AIGC-jubianage-agent --lines 50`
3. 检查数据库表：在Supabase中查看 `first_last_frame_videos` 表是否存在

## 本次更新内容

1. ✅ 调整首尾帧生视频页面UI：日期显示移到筛选区域（黄色框）
2. ✅ 创建专门的视频存储表：`first_last_frame_videos`
3. ✅ 优化后端逻辑：生成任务时保存到新表，完成时更新状态
4. ✅ 视频继续上传到COS，URL保存在新表中

