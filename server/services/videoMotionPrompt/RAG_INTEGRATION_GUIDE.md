# RAG 库集成指南

## ✅ 功能说明

系统已经完整集成了 RAG（检索增强生成）功能，可以：

1. **存储整个剧本文档**到 RAG 库
2. **自动检索相关片段**：根据当前分镜内容，从 RAG 库中检索相似度高的相关片段
3. **获取上下文窗口**：自动获取当前分镜前后的片段，保持剧情连贯性
4. **结合图片分析**：视觉模型直接分析图片 + RAG 检索的剧本上下文 = 更准确的提示词

## 📋 完整工作流程

```
1. 存储剧本文档 → RAG 库
   ↓
2. 提供图片 + 当前分镜内容
   ↓
3. 视觉模型分析图片内容
   ↓
4. RAG 检索相关剧本片段（相似度 >= 0.6）
   ↓
5. 获取上下文窗口（前后各 2 个分镜）
   ↓
6. 结合图片分析 + RAG 上下文 → 生成视频运动提示词
```

## 🚀 使用方法

### 步骤 1: 存储剧本文档到 RAG 库

```powershell
curl -X POST http://localhost:3002/api/rag/store-script `
  -H "Content-Type: application/json" `
  -d '{
    "scriptId": "script_001",
    "segments": [
      {
        "shotNumber": 1,
        "content": "男主角站在画面中央，周围有多个女性围绕着他。",
        "prompt": "景别：中景。主体: 男主角..."
      },
      {
        "shotNumber": 2,
        "content": "女主角从远处走来，步伐优雅...",
        "prompt": "景别：全景。主体: 女主角..."
      }
      // ... 更多片段
    ]
  }'
```

### 步骤 2: 生成视频运动提示词（自动使用 RAG）

```powershell
curl -X POST http://localhost:3002/api/generate-video-motion-prompt `
  -H "Content-Type: application/json" `
  -d '{
    "imageUrl": "https://example.com/image.jpg",
    "scriptContext": "男主角站在画面中央，周围有多个女性围绕着他。",
    "shotNumber": 1,
    "scriptId": "script_001",
    "characterInfo": "男主角：年轻英俊",
    "sceneInfo": "室内场景"
  }'
```

**系统会自动：**
- ✅ 从 RAG 库检索相关片段（相似度 >= 0.6）
- ✅ 获取当前分镜前后的上下文（窗口大小：2）
- ✅ 视觉模型分析图片内容
- ✅ 结合所有信息生成提示词

## 🧪 测试脚本

运行完整测试：

```powershell
cd C:\Users\Administrator\Desktop\AIGC-jubianage-agent\server
node services/videoMotionPrompt/test-with-rag.js
```

## ⚙️ RAG 配置

在 `server/.env` 文件中：

```env
# RAG 配置
RAG_ENABLED=true                    # 是否启用 RAG
RAG_VECTOR_DB_PATH=./data/rag_vectors  # RAG 数据存储路径
RAG_TOP_K=5                         # 检索前 5 个相关片段
RAG_SIMILARITY_THRESHOLD=0.6        # 相似度阈值（0-1）
```

## 📊 RAG 检索逻辑

### 1. 相似度计算
- 当前使用基于关键词匹配的相似度计算
- 提取关键词 → 计算交集/并集 → 得到相似度分数

### 2. 检索策略
- **相关片段检索**：检索与当前分镜内容相似度 >= 0.6 的片段
- **上下文窗口**：获取当前分镜前后各 2 个片段（共 4 个）
- **去重**：排除当前分镜本身

### 3. 结果合并
- 相关片段 + 上下文窗口 → 合并为完整的 RAG 上下文
- 按分镜编号排序，保持时间顺序

## 🎯 优势

### 结合视觉模型 + RAG 的优势：

1. **更准确的图片理解**
   - 视觉模型直接"看到"图片内容
   - 不再依赖剧本推断

2. **更好的剧情连贯性**
   - RAG 检索相关片段，了解整体剧情
   - 上下文窗口确保前后分镜的连贯性

3. **更智能的提示词生成**
   - 图片分析 + 剧本上下文 = 更准确的提示词
   - 动作和运镜更符合整体剧情

## 🔄 未来升级

当前 RAG 实现使用基于关键词的简单检索，未来可以升级到：

1. **向量数据库**（ChromaDB/Milvus）
   - 使用真正的向量相似度计算
   - 更准确的语义检索

2. **嵌入模型**
   - 使用专门的嵌入模型生成向量
   - 支持多语言和更复杂的语义理解

3. **混合检索**
   - 关键词检索 + 向量检索
   - 结合两种方法的优势

## 📝 示例输出

**输入：**
- 图片：男主角站在中央，周围有女性
- 当前分镜：分镜 1
- RAG 检索：找到分镜 2（女主角走来）和分镜 3（牵手）

**输出：**
```
提示词：镜头缓慢推进，男主角缓缓转身，目光扫过周围，然后聚焦在远处走来的女主角
置信度：0.9
```

## ✅ 总结

系统现在已经完整支持：
- ✅ 视觉模型直接分析图片
- ✅ RAG 库存储整个剧本文档
- ✅ 自动检索相关片段和上下文
- ✅ 结合图片分析和 RAG 上下文生成更准确的提示词

可以开始测试了！🎉

