# 修复 502 错误和语法错误 - 完整方案

## 问题总结

从 PM2 日志中发现了以下问题：

1. ✅ **已修复（本地）**：`musicStorageService.js` 数据库连接问题
2. ⚠️ **需要调查**：`SyntaxError: Missing initializer in const declaration` - 重复出现，可能是服务器上的代码版本不同

## 完整修复步骤

### 步骤1：确保本地代码是最新的并提交

```bash
# 在本地
cd C:\Users\Administrator\Desktop\AIGC-jubianage-agent

# 检查修改的文件
git status

# 添加所有修改
git add server/services/musicStorageService.js

# 提交
git commit -m "修复 musicStorageService 数据库连接问题和语法错误"

# 推送到 GitHub
git push origin main
```

### 步骤2：在服务器上拉取最新代码并重启

```bash
# SSH 连接到服务器
ssh ubuntu@119.45.121.152

# 进入项目目录
cd /var/www/aigc-agent

# 强制拉取最新代码
git fetch origin
git reset --hard origin/main

# 检查语法
cd server
node --check index.js

# 如果语法检查通过，重启服务
pm2 restart aigc-agent

# 等待服务启动
sleep 5

# 检查服务状态
pm2 list

# 测试健康检查
curl http://localhost:3002/api/health

# 查看日志
pm2 logs aigc-agent --lines 20
```

### 步骤3：如果问题仍然存在，检查具体文件

```bash
# 在服务器上检查所有服务文件的语法
cd /var/www/aigc-agent/server

for file in services/*.js; do
    echo "检查: $file"
    node --check "$file" 2>&1 | grep -i "syntax\|error" || echo "  ✅ 无语法错误"
done
```

### 步骤4：如果发现语法错误，手动修复

根据 `node --check` 的输出，找到有问题的文件和行号，然后修复。

## 快速修复脚本

我已经创建了以下脚本：

1. **`诊断并修复语法错误.sh`** - 诊断所有语法问题
2. **`快速修复语法错误-服务器执行.sh`** - 在服务器上直接执行的修复脚本

### 使用方法

**方法1：使用诊断脚本**
```bash
bash 诊断并修复语法错误.sh
```

**方法2：直接在服务器上执行修复脚本**
```bash
# 将脚本内容复制到服务器并执行
ssh ubuntu@119.45.121.152 "bash -s" < 快速修复语法错误-服务器执行.sh
```

## 已修复的问题

### 1. musicStorageService.js 数据库连接问题

**修复内容：**
- `getUserMusicList` 函数：从 `const { db } = await import(...)` 改为 `const pool = await import(...); const db = pool.default || pool`
- `saveMusicToDatabase` 函数：同样的修复
- `deleteMusic` 函数：同样的修复

**原因：** `connection.js` 使用默认导出 (`export default pool`)，但代码尝试使用命名导出。

## 如果问题仍然存在

### 检查点1：代码版本是否一致

```bash
# 在服务器上检查
cd /var/www/aigc-agent
git log --oneline -5
git status
```

### 检查点2：Node.js 版本

```bash
node --version
# 应该是 v18 或更高版本
```

### 检查点3：依赖是否完整

```bash
cd /var/www/aigc-agent/server
npm install
```

### 检查点4：环境变量

```bash
cd /var/www/aigc-agent/server
cat .env | grep -E "DB_|NODE_ENV"
```

## 预防措施

1. **设置 Git 钩子**：在提交前检查语法
2. **CI/CD 检查**：在部署前自动检查语法
3. **定期同步**：确保服务器代码与 GitHub 保持一致




