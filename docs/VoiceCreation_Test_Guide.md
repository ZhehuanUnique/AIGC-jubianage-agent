# 音色创作功能测试指南

## 功能概述

音色创作页面已重新设计，采用三栏布局，支持多种情感控制方式。

## 页面布局

### 三栏布局
- **左侧**：音色参考音频上传和播放控制
- **中间**：文本输入区域
- **右侧**：生成结果音频播放和下载

### 功能设置区域
位于三栏布局下方，包含：
- 情感控制方式选择（4种方式）
- 情感权重滑块
- 高级设置（可展开/收起）

## 功能说明

### 1. 音色参考音频
- 支持拖拽上传或点击上传
- 支持音频波形可视化
- 播放控制：播放/暂停、音量、倍速、快进/快退、循环播放
- 支持录音功能（待实现）

### 2. 文本输入
- 文本输入框
- 显示当前模型版本（2.0）
- 生成语音按钮

### 3. 生成结果
- 音频波形可视化
- 播放控制：播放/暂停、音量、倍速、快进/快退、下载

### 4. 情感控制方式

#### 方式0：与参考音频的音色相同
- 使用音色参考音频的情感
- 不需要额外设置

#### 方式1：使用单独的情感参考音频
- 需要上传情感参考音频
- 支持音频波形显示和播放控制
- 可设置情感权重（0-1，默认0.65）

#### 方式2：使用情感向量控制
- 8个情绪滑块：
  - 欢喜（joy）
  - 愤怒（anger）
  - 悲哀（sadness）
  - 恐惧（fear）
  - 厌恶（disgust）
  - 低落（low）
  - 惊喜（surprise）
  - 平静（calm）
- 每个滑块范围：0-1，步长0.05
- 支持情感随机采样开关
- 可设置情感权重（0-1，默认0.65）

#### 方式3：使用情感描述文本控制
- 文本输入框
- 示例：极度愤怒、非常高兴、危险在悄悄逼近
- 留空则自动使用目标文本作为情绪描述
- 可设置情感权重（0-1，默认0.65）
- 注意：此功能处于测试阶段，结果可能不太稳定

## 测试步骤

### 前置条件
1. 确保 IndexTTS2.5 服务已启动并正常运行
2. 检查服务状态指示器（页面右上角）显示"服务在线"

### 基础功能测试

#### 测试1：上传音色参考音频
1. 点击左侧"音色参考音频"区域的上传区域
2. 选择一个音频文件（支持常见音频格式）
3. 验证：
   - 音频波形是否正确显示
   - 播放控制按钮是否可用
   - 时间显示是否正确

#### 测试2：输入文本并生成
1. 在中间文本输入框输入测试文本（例如："你好，这是一个测试"）
2. 点击"生成语音"按钮
3. 验证：
   - 生成过程中按钮显示"生成中..."
   - 生成完成后右侧显示音频波形
   - 可以播放生成的音频

#### 测试3：情感控制方式0（与参考音频相同）
1. 上传音色参考音频
2. 选择"与参考音频的音色相同"
3. 输入文本并生成
4. 验证生成的音频情感与参考音频相似

#### 测试4：情感控制方式1（单独情感参考音频）
1. 上传音色参考音频
2. 选择"使用单独的情感参考音频"
3. 上传情感参考音频
4. 调整情感权重（例如：0.8）
5. 输入文本并生成
6. 验证：
   - 情感参考音频可以播放
   - 生成的音频情感受情感参考音频影响

#### 测试5：情感控制方式2（情感向量）
1. 上传音色参考音频
2. 选择"使用情感向量控制"
3. 调整情绪滑块（例如：将"愤怒"设为0.8，"欢喜"设为0.3）
4. 开启/关闭"情感随机采样"
5. 调整情感权重
6. 输入文本并生成
7. 验证：
   - 滑块值可以正确设置
   - 生成的音频情感符合设置的向量

#### 测试6：情感控制方式3（情感描述文本）
1. 上传音色参考音频
2. 选择"使用情感描述文本控制"
3. 输入情感描述（例如："极度愤怒"）
4. 调整情感权重
5. 输入文本并生成
6. 验证生成的音频情感符合描述

### 高级功能测试

#### 测试7：音频播放控制
1. 上传音频后，测试以下功能：
   - 播放/暂停
   - 音量控制（静音/取消静音）
   - 倍速切换（1x → 1.5x → 2x）
   - 快进/快退（±5秒）
   - 循环播放

#### 测试8：音频下载
1. 生成音频后，点击下载按钮
2. 验证文件是否正确下载

#### 测试9：高级设置
1. 点击"展开"按钮
2. 验证高级设置区域是否显示
3. 点击"收起"按钮
4. 验证高级设置区域是否隐藏

## 已知问题

1. **录音功能**：录音按钮已添加，但功能尚未实现
2. **高级生成参数设置**：高级设置区域已预留，但具体参数待实现
3. **情感描述文本**：此功能处于测试阶段，结果可能不太稳定

## API 接口说明

### 请求参数

```typescript
{
  text: string                    // 必填：要转换的文本
  voiceId?: string               // 可选：音色ID，默认'default'
  speed?: number                 // 可选：语速，默认1.0
  pitch?: number                 // 可选：音调，默认0
  format?: 'wav' | 'mp3' | 'ogg' // 可选：输出格式，默认'wav'
  referenceAudio?: string        // 可选：音色参考音频（base64）
  emotionControlMethod?: 0|1|2|3 // 可选：情感控制方式
  emotionReferenceAudio?: string // 可选：情感参考音频（base64）
  emotionWeight?: number         // 可选：情感权重（0-1）
  emotionVectors?: number[]     // 可选：情感向量（8个值）
  emotionText?: string           // 可选：情感描述文本
  emotionRandom?: boolean        // 可选：情感随机采样
}
```

### 响应格式

```typescript
{
  success: boolean
  audioUrl?: string    // 音频URL
  audioData?: string   // base64音频数据
  format?: string      // 输出格式
  duration?: number    // 音频时长（秒）
  error?: string      // 错误信息
}
```

## 故障排查

### 问题1：服务状态显示"离线"
- 检查 IndexTTS2.5 服务是否运行
- 检查服务地址配置是否正确
- 查看浏览器控制台错误信息

### 问题2：音频波形不显示
- 检查音频文件格式是否支持
- 查看浏览器控制台是否有错误
- 尝试刷新页面

### 问题3：生成失败
- 检查文本是否为空
- 检查是否上传了音色参考音频
- 查看服务器日志
- 检查网络连接

### 问题4：情感控制不生效
- 确认选择了正确的情感控制方式
- 检查相关参数是否正确设置（如情感权重、情感向量等）
- 查看服务器日志确认参数是否正确传递

## 开发说明

### 文件结构
- `src/pages/VoiceCreation.tsx` - 主页面组件
- `src/components/AudioWaveform.tsx` - 音频波形组件
- `src/services/indexTtsApi.ts` - API接口定义
- `server/index.js` - 后端API路由
- `server/services/indexTtsService.js` - IndexTTS2.5服务封装

### 待实现功能
1. 录音功能
2. 高级生成参数设置
3. 批量生成
4. 历史记录

## 更新日志

### 2024-XX-XX
- 重新设计UI，采用三栏布局
- 添加音频波形可视化
- 实现4种情感控制方式
- 添加情感权重滑块
- 实现8个情绪向量滑块
- 添加情感描述文本输入
- 更新API接口以支持新参数

