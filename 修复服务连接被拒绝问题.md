# 修复服务连接被拒绝问题

## 问题分析

从终端输出可以看到：
- ✅ PM2 显示服务状态为 `online`
- ❌ 但 `curl http://localhost:3002/api/health` 返回 "Connection refused"

这说明服务虽然被 PM2 标记为运行中，但实际上**没有监听 3002 端口**。

## 可能的原因

1. **服务启动时遇到错误，立即退出**
2. **服务监听的端口配置错误**
3. **服务启动失败但 PM2 没有正确检测到**
4. **语法错误导致服务无法启动**

## 诊断步骤

### 步骤1：查看服务日志

```bash
ssh ubuntu@119.45.121.152
cd /var/www/aigc-agent/server

# 查看所有日志（最近100行）
pm2 logs aigc-agent --lines 100

# 查看错误日志
pm2 logs aigc-agent --err --lines 50
```

### 步骤2：检查服务详细信息

```bash
# 查看服务详细信息
pm2 describe aigc-agent

# 检查重启次数
pm2 list | grep aigc-agent
```

### 步骤3：检查端口和进程

```bash
# 检查端口是否被监听
netstat -tulpn | grep 3002
# 或
lsof -i :3002

# 检查进程是否真的在运行
ps aux | grep "node.*index.js" | grep -v grep
```

### 步骤4：尝试手动启动服务（测试）

```bash
cd /var/www/aigc-agent/server

# 手动启动服务（查看错误信息）
node index.js
```

如果服务立即退出，会显示错误信息。

## 修复方案

### 方案1：如果服务启动失败

**查看错误日志，根据错误信息修复：**

```bash
# 查看完整错误日志
pm2 logs aigc-agent --err --lines 100

# 常见错误和修复：
# 1. 语法错误 -> 修复代码
# 2. 数据库连接失败 -> 检查 .env 配置
# 3. 端口被占用 -> 杀死占用端口的进程
# 4. 依赖缺失 -> npm install
```

### 方案2：完全重启服务

```bash
cd /var/www/aigc-agent/server

# 停止并删除服务
pm2 stop aigc-agent
pm2 delete aigc-agent

# 重新启动
pm2 start index.js --name aigc-agent --autorestart --max-memory-restart 1G

# 保存配置
pm2 save

# 等待启动
sleep 5

# 检查状态
pm2 list
pm2 logs aigc-agent --lines 20
```

### 方案3：检查并修复代码

```bash
cd /var/www/aigc-agent/server

# 检查语法
node --check index.js

# 如果发现语法错误，修复后重启
pm2 restart aigc-agent
```

### 方案4：检查环境变量

```bash
cd /var/www/aigc-agent/server

# 检查 .env 文件
cat .env | grep -E "PORT|DB_|NODE_ENV"

# 确保端口配置正确
grep PORT .env || echo "PORT=3002" >> .env
```

## 快速修复命令（一键执行）

```bash
ssh ubuntu@119.45.121.152 << 'ENDSSH'
cd /var/www/aigc-agent/server

echo "1. 停止服务..."
pm2 stop aigc-agent
pm2 delete aigc-agent

echo "2. 检查语法..."
node --check index.js || echo "语法检查失败"

echo "3. 重新启动服务..."
pm2 start index.js --name aigc-agent --autorestart --max-memory-restart 1G
pm2 save

echo "4. 等待启动..."
sleep 5

echo "5. 检查状态..."
pm2 list | grep aigc-agent

echo "6. 测试健康检查..."
curl http://localhost:3002/api/health || echo "服务仍未响应"

echo "7. 查看日志..."
pm2 logs aigc-agent --lines 20 --nostream
ENDSSH
```

## 验证修复

修复后，执行以下命令验证：

```bash
# 1. 检查服务状态
pm2 list | grep aigc-agent

# 2. 检查端口
netstat -tulpn | grep 3002

# 3. 测试健康检查
curl http://localhost:3002/api/health

# 4. 查看日志（应该没有错误）
pm2 logs aigc-agent --lines 10
```

## 预期结果

修复成功后：
- ✅ PM2 显示服务状态为 `online`
- ✅ 端口 3002 被监听
- ✅ `curl http://localhost:3002/api/health` 返回 JSON 响应
- ✅ 登录功能恢复正常




