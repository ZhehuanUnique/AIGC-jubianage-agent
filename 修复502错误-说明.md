# 修复 502 Bad Gateway 错误

## 问题描述

登录时出现 **502 Bad Gateway** 错误，这表明：
- Nginx 无法连接到后端服务器（localhost:3002）
- 后端服务可能未运行或已崩溃

## 快速修复步骤

### 方法1：通过 SSH 手动修复（推荐）

1. **连接到服务器**
```bash
ssh ubuntu@119.45.121.152
```

2. **检查 PM2 服务状态**
```bash
pm2 list
```

3. **检查后端服务是否响应**
```bash
curl http://localhost:3002/api/health
```

4. **如果服务未运行，重启服务**
```bash
cd /var/www/aigc-agent/server
pm2 restart aigc-agent
```

5. **如果重启失败，完全重启**
```bash
cd /var/www/aigc-agent/server
pm2 stop aigc-agent
pm2 delete aigc-agent
pm2 start index.js --name aigc-agent --autorestart --max-memory-restart 1G
pm2 save
```

6. **检查服务日志**
```bash
pm2 logs aigc-agent --lines 50
```

7. **验证服务是否恢复**
```bash
curl http://localhost:3002/api/health
```

### 方法2：使用提供的脚本

**Windows PowerShell:**
```powershell
.\检查并修复后端服务.ps1
```

**Linux/Mac/Git Bash:**
```bash
bash 检查并修复后端服务.sh
```

## 常见问题排查

### 1. 端口被占用但服务未响应

```bash
# 检查端口占用
lsof -i :3002

# 如果端口被占用但服务无响应，杀死进程
kill -9 <PID>

# 然后重启服务
cd /var/www/aigc-agent/server
pm2 start index.js --name aigc-agent
```

### 2. 服务启动失败（查看错误日志）

```bash
cd /var/www/aigc-agent/server
pm2 logs aigc-agent --err --lines 100
```

常见错误：
- **数据库连接失败**：检查 `.env` 文件中的数据库配置
- **端口被占用**：检查是否有其他进程占用 3002 端口
- **依赖缺失**：运行 `npm install` 安装依赖

### 3. Nginx 配置问题

```bash
# 检查 Nginx 配置
sudo nginx -t

# 查看 Nginx 错误日志
sudo tail -f /var/log/nginx/error.log

# 重新加载 Nginx 配置
sudo systemctl reload nginx
```

### 4. 环境变量问题

```bash
# 检查 .env 文件是否存在
cd /var/www/aigc-agent/server
ls -la .env

# 检查关键环境变量
cat .env | grep -E "DB_|PORT|NODE_ENV"
```

## 预防措施

### 1. 设置 PM2 自动重启

确保 `ecosystem.config.js` 或启动命令包含 `--autorestart`：

```bash
pm2 start index.js --name aigc-agent --autorestart --max-memory-restart 1G
pm2 save
```

### 2. 设置系统服务（可选）

创建 systemd 服务文件，确保服务器重启后自动启动：

```bash
# 创建服务文件
sudo nano /etc/systemd/system/aigc-agent.service
```

内容：
```ini
[Unit]
Description=AIGC Agent Backend
After=network.target

[Service]
Type=simple
User=ubuntu
WorkingDirectory=/var/www/aigc-agent/server
ExecStart=/usr/bin/node index.js
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启用服务：
```bash
sudo systemctl enable aigc-agent
sudo systemctl start aigc-agent
```

## 验证修复

修复后，在浏览器中：
1. 刷新登录页面
2. 尝试登录
3. 检查浏览器控制台是否还有 502 错误

如果问题仍然存在，请检查：
- PM2 日志：`pm2 logs aigc-agent`
- Nginx 错误日志：`sudo tail -f /var/log/nginx/error.log`
- 后端服务日志：`pm2 logs aigc-agent --err`

